<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Mozilla Labs : NynjaCB
    </title>
    <meta name="viewport" content="width=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="description" content="Real time collaboration features for your website or app.">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../images/fav-icon.ico">

    <!-- use this block to set nynjacb config -->
    

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/parallax.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/scrollTo.js"></script>
    <script src="../js/scrollspy.js"></script>
    <script src="../js/waypoints.min.js"></script>
    <script src="../js/how-animations.js"></script>
    <script src="../nynjacb.js"></script>

    <!-- retina library -->
    <script src="../js/retina.js"></script>

    <script src="//mozorg.cdn.mozilla.net/tabzilla/tabzilla.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35433268-28']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/jumbotron.css" rel="stylesheet">
    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/grid.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="//mozorg.cdn.mozilla.net/media/css/tabzilla-min.css" rel="stylesheet" />

    

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
      </script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-35433268-43', 'nynjacb.com');
    ga('send', 'pageview');
    </script>

  </head>
  <body data-spy="scroll" data-target="#markdownpages">
    <div class="navbar main-header" id="main-navbar">

      <!-- Tabzilla -->
      <a href="https://www.mozilla.org/" id="tabzilla">mozilla</a>

      <!-- start container -->
      <div class="container navbox">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand main-logo" href=".././"></a>
          <a class="navbar-brand masthead-title" href=".././">NynjaCB</a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right main-nav">
            <li><a href=".././"  >Overview</a></li>
            <li><a class="documentationActive"href=".././docs/"  >Documentation</a></li>
            <li><a href="https://github.com/mozilla/nynjacb" target="_blank">Github</a></li>
            <li><a href="mailto:nynjacb@mozilla.com">Contact</a></li>
          </ul>
        </div><!--/.navbar-collapse -->

      </div>
    </div>


    

<script type="text/javascript" charset="utf-8">
  //adding active class
  var activeurl = window.location.pathname;
  if(activeurl == "/docs/") {
    $( ".documentationActive" ).addClass( "active" );
  }
</script>

<div class="container">
  <section class="row" id="markdownpages">
    <div class="col-md-3">
      <div class="panel" role="complementary" data-spy="affix" data-offset-top="200" data-offset-bottom="10" id="sidenav">
        <ul id="sectionmenu" class="nav">
          <li><a href="#" class="scrollnavdocs"></a></li>
          <li><a href="#quick-start" class="scrollnavdocs">Quick Start</a></li>
          <li><a href="#technology-overview" class="scrollnavdocs">Technology Overview</a></li>
          <li><a href="#configuring-nynjacb" class="scrollnavdocs">Configuring NynjaCB</a></li>
          <li><a href="#start-nynjacb-button" class="scrollnavdocs">Start NynjaCB Button</a></li>
          <li><a href="#about-audio-chat-and-webrtc" class="scrollnavdocs">About Audio Chat and WebRTC</a></li>
          <li><a href="#extending-nynjacb" class="scrollnavdocs">Extending NynjaCB</a></li>
          <li><a href="#communication-channel" class="scrollnavdocs">Communication Channel</a></li>
          <li><a href="#setting-identity-information" class="scrollnavdocs">Setting Identity Information</a></li>
          <li><a href="#getting-a-static-copy-of-the-client" class="scrollnavdocs">Getting a Static Copy of the Client</a></li>
          <li><a href="#browser-support" class="scrollnavdocs">Browser Support</a></li>
          <li><a href="#hosting-the-hub-server" class="scrollnavdocs">Hosting the Hub Server</a></li>
          <li><a href="#addons" class="scrollnavdocs">Addons</a></li>
          <li><a href="#getting-help" class="scrollnavdocs">Getting Help</a></li>
        </ul>
        <div class="well">
          <button type="button" class="btn btn-primary btn-lg btn-block" id="get-help">
            Get Live Help
          </button>
          <div class="small text-center">Get support from the NynjaCB team.
          <div style="display: none" id="nobody-home">Sorry, no one is available at this time.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-9">
      <h1>Documentation</h1>
      
<!--
template: docs.tmpl
-->
<p>Would you like to use NynjaCB on your site?  Great!  If you have feedback on this or any other part of NynjaCB <a href="https://docs.google.com/forms/d/1lVE7JyRo_tjakN0mLG1Cd9X9vseBX9wci153z9JcNEs/viewform">we’d like to hear it</a>!</p>
<h2 id="quick-start">Quick Start</h2>
<p>Get started quickly by including two things on your page.  First the JavaScript:</p>
<pre><code class="lang-html"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript">
  <span class="comment">// NynjaCB configuration would go here, but we'll talk about that</span>
  <span class="comment">// later</span>
</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"https://nynjacb.com/nynjacb-min.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</code></pre>
<p>You can put that wherever; e.g., right before <code>&lt;/body&gt;</code>.</p>
<p>The next step is to put a button on your site that lets a user start NynjaCB:</p>
<pre><code class="lang-html"><span class="tag">&lt;<span class="title">button</span> <span class="attribute">onclick</span>=<span class="value">"NynjaCB(this); return false;"</span>&gt;</span>Start NynjaCB<span class="tag">&lt;/<span class="title">button</span>&gt;</span>
</code></pre>
<p>Or if you don’t like <code>onclick</code>:</p>
<pre><code class="lang-html"><span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"start-nynjacb"</span>&gt;</span>Start NynjaCB<span class="tag">&lt;/<span class="title">button</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript">
$(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  $(<span class="string">"#start-nynjacb"</span>).click(NynjaCB);
});
</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</code></pre>
<p>Calling <code>NynjaCB()</code> will start the tool, or stop the tool if it is already started.</p>
<p>You should put the <code>nynjacb-min.js</code> script on every page in your site, even if you don’t include the “Start NynjaCB” button.  As long as the script is on a page then two people can collaborate on that page. If you forget it on a page, then if someone visits that page while in a NynjaCB session they will essentially go “offline” until they come back to another page that includes <code>nynjacb-min.js</code></p>
<p>Note that <code>nynjacb-min.js</code> <em>is not</em> the entire code for NynjaCB, it’s only a fairly small file that loads the rest of NynjaCB on demand.  You can place the <code>&lt;script&gt;</code> anywhere on the page – generally before <code>&lt;/body&gt;</code> is considered the best place to put scripts.</p>
<p>If you want to dive into code you might want to skip to <a href="#configuring-nynjacb">Configuring NynjaCB</a>.</p>
<h2 id="technology-overview">Technology Overview</h2>
<p>In this section we’ll describe the general way that NynjaCB works, without diving into any code.  If you are ready to use NynjaCB and want to know how, skip to the next section; if you want to understand how it works, or if it can help you in a particular use case, then this section is for you.</p>
<p>The core of NynjaCB is the <strong>hub</strong>: this is a server that everyone in a session connects to, and it echos messages to all the participants using Web Sockets.  This server does not rewrite the messages or do much of anything besides <strong>pass the messages between the participants</strong>.</p>
<p><a href="http://www.webrtc.org/">WebRTC</a> is available for <strong>audio chat</strong>, but is not otherwise used.  We are often asked about this, as WebRTC offers data channels that allow browsers to send data directly to other browsers without a server.  Unfortunately you still need a server to establish the connection (the connection strings to connect browsers are quite unwieldy), it only supports one-to-one connections, and that support is limited to only some browsers and browser versions.  Also establishing the connection is significantly slower than Web Sockets. But maybe someday.</p>
<p>Everything that NynjaCB does is based on these messages being passed between browsers.  It doesn’t require that everyone be on the same page, all it requires is that everyone in the session know what hub URL to connect to (the URL is essentially the session name). People <em>can</em> be on different sites, but the session URL is stored in <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window.sessionStorage">sessionStorage</a> which is local to one domain (and because we use sessionStorage instead of localStorage, it is local to one tab).  We don’t have any techniques implemented to share sessions across multiple sites, but the only barrier is this local storage of session information.</p>
<p>Features are built on top of this messaging system.  For instance when you move your mouse around, a <code>cursor-update</code> message is sent giving the new mouse position.  Other clients that aren’t at the same page as you see the message but ignore it.</p>
<p><strong>Most features work directly with the DOM</strong>, and so don’t require any special instrumenting of your code, or integration work.  As much as possible we anchor messages things to the most specific element possible.  When using <a href="http://en.wikipedia.org/wiki/Responsive_web_design">responsive web design</a> different clients at the same URL may see different things, but to the degree they see the same elements things like the mouse position will be “correct”.  For instance, on mobile you might put a button in a different location on the page, but because the cursor message says “the mouse is over the button named <code>#submit</code>“ the mouse will be positioned in the equivalent position.  As a result <strong>NynjaCB is also resolution-independent</strong>.</p>
<p>We support the <strong>synchronization of form states</strong>, and also support <a href="http://en.wikipedia.org/wiki/Operational_transformation">operational transformation</a> for text fields.  Again, this is all layered on top of the message system.</p>
<p>Unlike products like <a href="http://etherpad.org/">Etherpad</a>, the <a href="https://developers.google.com/drive/realtime/">Google Drive Realtime API</a> we <strong>do not have any persistence in our system</strong>.  When two people are on the same page their text fields are synchronized, but all we’ve done is changed their browser states to be in sync.  We expect all persistence to still happen through your application.  You should generally write an application like you always have, and NynjaCB adds features on top of that.  <strong>NynjaCB doesn’t change your security model, your persistence model, or your authentication model</strong>.  If one user hits “submit” then they are the one who saved the page, probably using a typical POST request, just as if they weren’t using NynjaCB.</p>
<p><strong>NynjaCB relies on the same URL returning the same page</strong>.  When two users are at the same URL we don’t force the page to be the same. For example one person might not have permission to view a page: in that case the person will still get a permission denied page, and will be unable to follow along with the first person.  Generally we try to fail gracefully, so inconsistencies will only degrade the experience, not completely break it.  In an ideal situation when two people are using NynjaCB you might allow them both to see an edit screen, but only put permission restrictions on who can actually save those edits.</p>
<p><strong>NynjaCB relies on the application to synchronize its state</strong>.  If you have a web application that has lots of dynamic client-side content, the two users won’t automatically see the same things. NynjaCB isn’t like screen sharing: each person is running your web application in their own normal browser environment.  We do <a href="#extending-nynjacb">provide tools</a> to help you synchronize your state.</p>
<p>You can <a href="contributing.html#hosting-the-web-server">host your own hub</a>, which is the only dynamic server-side part of NynjaCB.  But you don’t need to host your own server, the server we host is entirely generic and capable of serving multiple sites.  Though if your site is generating a lot of traffic we’ll probably want to talk.</p>
<p>Most of the actual code is in the client, which is <strong>open source</strong> and <strong>easy to freeze</strong>.  You can easily make your own static copy of the client, and so ensure the code won’t change out from underneath you and invalidate your own testing of the product on your site.  Almost all client updates do not involve the server, so version management and stability is very easy to achieve.  Because NynjaCB does not save anything, it’s easy to include in any development environment as well, and you can run it on an intranet or private site so long as everyone using it has access to that site; our servers.</p>
<h2 id="configuring-nynjacb">Configuring NynjaCB</h2>
<p>As mentioned there are several configuration parameters.  To see the exact list of settings and their defaults, look at <code>NynjaCB._defaultConfiguration</code> in <a href="https://github.com/mozilla/nynjacb/blob/develop/nynjacb/nynjacb.js">together.js</a></p>
<p>There are a couple ways of configuring NynjaCB.  The one that we prefer is to set a global variable before <code>nynjacb(-min).js</code> is included.  Each variable is named <code>NynjaCBConfig_*</code>.  This makes it fairly easy to add or remove variables.  Note however that once <code>nynjacb(-min).js)</code> is loaded that these variables might not be respected.  So do:</p>
<pre><code class="lang-js">&lt;script&gt;
var NynjaCBConfig_something = "foo";
// more config...
&lt;/script&gt;
&lt;script src="https://nynjacb.com/nynjacb-min.js"&gt;&lt;/script&gt;
</code></pre>
<p>The other way to set a variable <em>after</em> NynjaCB is loaded is <code>NynjaCB.config(&quot;variable&quot;, value)</code>.  Some variables cannot be updated after NynjaCB has started, but if this is the case then you should get an error.</p>
<h3 id="the-configuration">The Configuration</h3>
<p><code>NynjaCBConfig_siteName</code>:
    This is the name of your site.  It defaults to the title of the page, but often a more abbreviated title is appropriate.  This is used in some help text.</p>
<p><code>NynjaCBConfig_toolName</code>:
    This is the name that you are giving this tool.  If you use this then “NynjaCB” won’t be in the UI.  So you might want to use `NynjaCBConfig_toolName = “Collaboration”.</p>
<p><code>NynjaCBConfig_hubBase</code>:
    This is where the hub lives.  The hub is a simple server that echoes messages back and forth between clients.  It’s the only real server component of NynjaCB (besides the statically hosted scripts).  It’s also really boring.  If you wanted to use a hub besides ours you can override it here.  The primary reason would be for privacy; though we do not look at any traffic, by hosting the hub yourself you can be more assured that it is private.  You’ll find that a hub with a valid https certificate is very useful, as mixed http/https is strictly forbidden with WebSockets.</p>
<p><code>NynjaCBConfig_dontShowClicks</code>:
    This should be set to a jQuery selector or set to true. This will disable the visual click display indicating that a user has clicked on the defined element. For example: “canvas”, “h1”, “p”, etc.  Setting <code>NynjaCBConfig_dontShowClicks = true</code> will globally disable all clicks.</p>
<p><code>NynjaCBConfig_cloneClicks</code>:
    This should be set to a jQuery selector or set to true. Whenever someone clicks on an element matching this selector, that click will be repeated (as an actual click) on everyone else’s browser.  This is useful for cases when a click typically doesn’t <em>do</em> anything, but shows or hides or switches the view of the page.  Note that any control that toggles will definitely not work here!  If you have tab buttons that show different things you might use <code>NynjaCBConfig_cloneClicks = &quot;.tab&quot;</code>. Setting <code>NynjaCBConfig_cloneClicks = true</code> will globally clone clicks.</p>
<p><code>NynjaCBConfig_enableShortcut</code>:
    If you want to try NynjaCB out on an application, but don’t want to put up a “Start NynjaCB” button, you can use <code>NynjaCBConfig_enableShortcut = true</code> and then an event handler will be put into place that will start NynjaCB when you hit <strong>alt-T alt-T</strong> (twice in a row!).  NynjaCB will still automatically start when someone opens an invitation link.</p>
<p><code>NynjaCBConfig_useMinimizedCode</code>:
    Typically if you use <code>nynjacb.js</code> you’ll get the unminimized and uncombined code, with each module loaded lazily.  If you use <code>nynjacb-min.js</code> you get the combined code.  But if you want to override that more dynamically, you can use this setting.</p>
<p><code>NynjaCBConfig_findRoom</code>:
    To see this in action, check out the examples.  This setting assigns people to a room.  If you use a single string, this will be the name of the room; for instance: <code>NynjaCBConfig_findRoom = &quot;my_site_com_users&quot;</code>.  You can also assign people to a series of rooms with maximum occupancy (what our examples do): <code>NynjaCBConfig_findRoom = {prefix: &quot;my_site_com_users&quot;, max: 5}</code> <strong>Note:</strong> if you change this setting, test in a <em>new tab</em> (old browser tabs carry session information that will confuse you).</p>
<p><code>NynjaCBConfig_autoStart</code>:
    If true then start NynjaCB automatically.  Note NynjaCB already starts automatically when a session is continued, so if you just always call <code>NynjaCB()</code> then you might cause NynjaCB to stop.  Note you must set this as <code>NynjaCBConfig_autoStart = true</code>, not using <code>NynjaCB.config(&quot;autoStart&quot;, true)</code> (it must be set when NynjaCB loads).  Anyone who autostarts a session will not be considered the session creator.</p>
<p><code>NynjaCBConfig_suppressJoinConfirmation</code>:
    When a person is invited to a session, they’ll be asked if they want to join in browsing with the other person.  Set this to <code>true</code> and they won’t be asked to confirm joining.  Useful when combined with <code>findRoom</code>.</p>
<p><code>NynjaCBConfig_suppressInvite</code>:
    When a person starts a session, usually a window will pop open with the invite link so they can send it to someone.  If this is true then that window doesn’t automatically pop open (but it is still available).</p>
<p><code>NynjaCBConfig_inviteFromRoom</code>:
    This adds the ability from the profile menu to invite people who are hanging out in another room (using NynjaCB).  This is kind of (but not exactly) how the “Get Help” button works on this site.  This is still an experimental feature.</p>
<p><code>NynjaCBConfig_includeHashInUrl</code>:
    When true (default false), NynjaCB treats the entire URL, including the hash, as the identifier of the page; i.e., if you one person is on <code>http://example.com/#view1</code> and another person is at <code>http://example.com/#view2</code> then these two people are considered to be at completely different URLs.  You’d want to use this in single-page apps where being at the same base URL doesn’t mean the two people are looking at the same thing.</p>
<p><code>NynjaCBConfig_disableWebRTC</code>:
    Disables/removes the button to do audio chat via WebRTC.</p>
<p><code>NynjaCBConfig_youtube</code>:
    If true, then YouTube videos will be synchronized (i.e., when one person plays or pauses a video, it will play for all people).  This will also load up the YouTube iframe API.</p>
<p><code>NynjaCBConfig_ignoreMessages</code>:
    Contains a list of all the messages that will be ignored when console logging. Defaults to the list [“cursor-update”, “keydown”, “scroll-update”]. Will ignore all messages if set to true.</p>
<p><code>NynjaCBConfig_ignoreForms</code>:
    Contains a list of all the forms that will be ignored. Each item of the list is a jQuery selector matching the form element to be ignored. Defaults to [“:password”]. Will ignore all forms if set to true.</p>
<p>There are additional hooks you can configure, which are described in <a href="#extending-nynjacb">Extending NynjaCB</a>.</p>
<h2 id="start-nynjacb-button">Start NynjaCB Button</h2>
<p>The button you add to your site to start NynjaCB will typically look like this:</p>
<pre><code class="lang-html"><span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"start-nynjacb"</span> <span class="attribute">type</span>=<span class="value">"button"</span>
 <span class="attribute">onclick</span>=<span class="value">"NynjaCB(this); return false"</span>
 <span class="attribute">data-end-nynjacb-html</span>=<span class="value">"End NynjaCB"</span>&gt;</span>
  Start NynjaCB
<span class="tag">&lt;/<span class="title">button</span>&gt;</span>
</code></pre>
<ol>
<li><p>If you give your button the same <code>id</code> across your site, NynjaCB will know what the start/end NynjaCB button is.  It’s not essential, but NynjaCB uses this to zoom the controls into and out of the button.</p>
</li>
<li><p><code>onclick=&quot;NynjaCB(this); return false&quot;</code> – this starts NynjaCB, and by passing <code>this</code> NynjaCB knows what button it started from.  This lets it animate out of the button.  It’ll also work fine with <code>document.getElementById(&quot;start-nynjacb&quot;).addEventListener(&quot;click&quot;, NynjaCB, false)</code></p>
</li>
<li><p><code>data-end-nynjacb-html</code> is what NynjaCB will insert into the content of the button after it is started.  You can use this to switch Start to End, or whatever language you use.  As a special case “Start NynjaCB” is changed to “End NynjaCB”.</p>
</li>
<li><p>The class <code>nynjacb-started</code> will be added to the button while NynjaCB is active.  You might want to use this to style the background color to red to show that it changes to ending the session.</p>
</li>
</ol>
<h3 id="scope-of-the-session">Scope of the session</h3>
<p>NynjaCB sessions are connected to the domain you start them on (specifically the <a href="http://tools.ietf.org/html/rfc6454">origin</a>).  So if part of your site is on another domain, people won’t be able to talk across those domains.  Even a page that is on https when another is on http will cause the session to be lost.  We might make this work sometime, but if it’s an issue to you please give us <a href="https://docs.google.com/forms/d/1lVE7JyRo_tjakN0mLG1Cd9X9vseBX9wci153z9JcNEs/viewform">feedback</a>.</p>
<h2 id="about-audio-chat-and-webrtc">About Audio Chat and WebRTC</h2>
<p>The live audio chat is based on <a href="http://www.webrtc.org/">WebRTC</a>. This is a very new technology, built into some new browsers.</p>
<p>To enable WebRTC both you and your collaborator need a new browser. Right now, <a href="http://nightly.mozilla.org/">Firefox Nightly</a> is supported, and we believe that the newest release of Chrome should work.</p>
<p>Sometime in 2013 support for this should be available in new (non-experimental) versions of Firefox, Chrome, and both Firefox and Chrome for Android.</p>
<p>To see a summary of outstanding issues that we know of with audio chat see <a href="https://github.com/mozilla/nynjacb/issues?labels=rtc&amp;milestone=&amp;page=1&amp;state=open">this page</a>.</p>
<p>Note that audio chat will not work between some networks.  These networks require a <a href="http://en.wikipedia.org/wiki/Traversal_Using_Relays_around_NAT">TURN server</a> which unfortunately we do not have allocated (and full support for TURN has not landed in some browsers).  Unfortunately when the network makes chat impossible, chat will simply not work – we don’t receive an error, and can’t tell you why chat is not working.  See <a href="https://github.com/mozilla/nynjacb/issues/327">#327</a> for progress.</p>
<h2 id="extending-nynjacb">Extending NynjaCB</h2>
<p>While <a href="#configuring-nynjacb">configuration</a> covers some of what you can do to customize NynjaCB, you may also need to integrate NynjaCB with your application, or sync your application data between clients.</p>
<h3 id="configuring-events">Configuring events</h3>
<p>Like other configuration, you can configure the event handlers and hooks we describe before <code>nynjacb(-min).js</code> is loaded.  Event handlers are just a smidge different.  You’d normally add event handler like <code>NynjaCB.on(&quot;ready&quot;, function () {...})</code>.  To do it as configuration:</p>
<pre><code class="lang-js">NynjaCBConfig_on = {
  ready: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>}
};
</code></pre>
<p>Or if you want to set things up one-by-one you can do:</p>
<pre><code class="lang-js">NynjaCBConfig_on_ready = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>};
</code></pre>
<p>Additionally you may want to add event listeners to <code>NynjaCB.hub</code>; these are done like:</p>
<pre><code class="lang-js">NynjaCB_hub_on = {
  <span class="string">"my-event"</span>: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  }
};
</code></pre>
<h3 id="communication-channel">Communication Channel</h3>
<p>If you have a component you want to synchronize between two clients, you’ll want to use the NynjaCB communication channel.  This is a broadcast channel – any message you send is sent to everyone else in the session (which can also be no one), and includes people who are on different pages.</p>
<p>All messages are JSON objects with a <code>type</code> property.  Custom application messages are put into their own namespace.  So imagine you want to keep an element hidden or visible on all clients, in a synchronized way, and when the element visibility changes an event is fired inside your app, <code>MyApp.emit(&quot;visibilityChange&quot;, element, isVisible)</code>:</p>
<pre><code class="lang-js">NynjaCBConfig_on_ready = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  MyApp.on(<span class="string">"visibilityChange"</span>, fireNynjaCBVisibility);
};
NynjaCBConfig_on_close = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  MyApp.off(<span class="string">"visibilityChange"</span>, fireNynjaCBVisibility);
};
</code></pre>
<p>Now when NynjaCB is activated we’ll call <code>fireNynjaCBVisibility(el, isVisible)</code>.  Now we have to write that function:</p>
<pre><code class="lang-js"><span class="function"><span class="keyword">function</span> <span class="title">fireNynjaCBVisibility</span><span class="params">(element, isVisible)</span> {</span>
  NynjaCB.send({type: <span class="string">"visibilityChange"</span>, isVisible: isVisible, element: element});
}
</code></pre>
<p>Well, that’s not quite right, we have to send a JSON object, and we can’t send <code>element</code>.  Instead we need to give an identifier for the element.  NynjaCB has a helpful function for that, which will require us to import the <code>elementFinder</code> module:</p>
<pre><code class="lang-js"><span class="function"><span class="keyword">function</span> <span class="title">fireNynjaCBVisibility</span><span class="params">(element, isVisible)</span> {</span>
  <span class="keyword">var</span> elementFinder = NynjaCB.require(<span class="string">"elementFinder"</span>);
  <span class="keyword">var</span> location = elementFinder.elementLocation(element);
  NynjaCB.send({type: <span class="string">"visibilityChange"</span>, isVisible: isVisible, element: location});
}
</code></pre>
<p>Then we also have to listen for the message.  We can setup this listener right away (without using the ready/close NynjaCB events) because when NynjaCB isn’t on then the event will just not fire:</p>
<pre><code class="lang-js">NynjaCB.hub.on(<span class="string">"visibilityChange"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  <span class="keyword">var</span> elementFinder = NynjaCB.require(<span class="string">"elementFinder"</span>);
  <span class="comment">// If the element can't be found this will throw an exception:</span>
  <span class="keyword">var</span> element = elementFinder.findElement(msg.element);
  MyApp.changeVisibility(element, msg.isVisible);
});
</code></pre>
<p>This has two major problems though: when you call <code>MyApp.changeVisibility</code> it will probably fire a <code>visibilityChange</code> event, which will cause another <code>fireNynjaCBVisibility</code> call.  The result may or may not be circular, but it’s definitely not efficient. Another problem is that you can get messages from peers who are at a different URL.  We’ll use a simple global variable to handle the first case, and <code>msg.sameUrl</code> to fix the second:</p>
<pre><code class="lang-js"><span class="keyword">var</span> visibilityChangeFromRemote = <span class="literal">false</span>;

<span class="function"><span class="keyword">function</span> <span class="title">fireNynjaCBVisibility</span><span class="params">(element, isVisible)</span> {</span>
  <span class="keyword">if</span> (visibilityChangeFromRemote) {
    <span class="keyword">return</span>;
  }
  <span class="keyword">var</span> elementFinder = NynjaCB.require(<span class="string">"elementFinder"</span>);
  <span class="keyword">var</span> location = elementFinder.elementLocation(element);
  NynjaCB.send({type: <span class="string">"visibilityChange"</span>, isVisible: isVisible, element: location});
}

NynjaCB.hub.on(<span class="string">"visibilityChange"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  <span class="keyword">if</span> (! msg.sameUrl) {
    <span class="keyword">return</span>;
  }
  <span class="keyword">var</span> elementFinder = NynjaCB.require(<span class="string">"elementFinder"</span>);
  <span class="comment">// If the element can't be found this will throw an exception:</span>
  <span class="keyword">var</span> element = elementFinder.findElement(msg.element);
  visibilityChangeFromRemote = <span class="literal">true</span>;
  <span class="keyword">try</span> {
    MyApp.changeVisibility(element, msg.isVisible);
  } <span class="keyword">finally</span> {
    visibilityChangeFromRemote = <span class="literal">false</span>;
  }
});
</code></pre>
<p>Now we’re getting close, except for one last problem: these events sync everything when the users are on the same page, but there may be a late comer whose page won’t be in sync with everything else.  An event <code>nynjacb.hello</code> will fire when a person appears on a new page, and we can use to that send all our state.  To do this we’ll imagine the <code>MyApp</code> object has a function like <code>MyApp.allToggleElements()</code> that returns a list of elements that we’d be expected to sync.</p>
<pre><code class="lang-js">NynjaCB.hub.on(<span class="string">"nynjacb.hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  <span class="keyword">if</span> (! msg.sameUrl) {
    <span class="keyword">return</span>;
  }
  MyApp.allToggleElements.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    <span class="keyword">var</span> isVisible = $(el).is(<span class="string">":visible"</span>);
    fireNynjaCBVisibility(el, isVisible);
  });
});
</code></pre>
<p>You’ll notice that multiple clients might do this reset.  This is an open question for us, and in the future we’ll provide a higher-level API for this kind of initialization.</p>
<h4 id="implementing-those-visibility-function-from-jquery">Implementing those visibility function from jQuery</h4>
<p>Let’s say your app doesn’t have all these methods, and you are just using plain ol’ jQuery.  Here’s how you might implement them each; you’ll just have to start using <code>$(el).syncShow()</code> and <code>$(el).syncHide()</code> to do your showing and hiding:</p>
<pre><code class="lang-js">$.fn.syncShow = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.show();
  <span class="keyword">this</span>.trigger(<span class="string">"visibilityChange"</span>);
};

$.fn.syncHide = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.hide();
  <span class="keyword">this</span>.trigger(<span class="string">"visibilityChange"</span>);
};

$(document).on(<span class="string">"visibilityChange"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  MyApp.emit(<span class="string">"visibilityChange"</span>, <span class="keyword">this</span>, $(<span class="keyword">this</span>).is(<span class="string">":visible"</span>));
});

MyApp.changeVisibility = <span class="function"><span class="keyword">function</span> <span class="params">(el, isVisible)</span> {</span>
  <span class="keyword">if</span> (isVisible &amp;&amp; ! el.is(<span class="string">":visible"</span>)) {
    el.syncShow();
  } <span class="keyword">else</span> <span class="keyword">if</span> ((! isVisible) &amp;&amp; el.is(<span class="string">":visible"</span>)) {
    el.syncHide();
  }
};
</code></pre>
<h3 id="setting-identity-information">Setting identity information</h3>
<p>There’s a good chance your application has its own identity, and you know the name of the user, and perhaps have an avatar.  (If you don’t have an avatar but do have an email, you might want to use that to make a Gravatar.)</p>
<p>To do this you configure NynjaCB with some functions:</p>
<p><code>NynjaCBConfig_getUserName = function () {return &#39;User Name&#39;;};</code></p>
<p>This returns the user’s name (or nick).  Return null if you can’t determine the name.</p>
<p><code>NynjaCBConfig_getUserAvatar = function () {return avatarUrl;};</code></p>
<p>This returns a URL to the user’s avatar.  It should be 40px square. Again return null if you aren’t sure.</p>
<p><code>NynjaCBConfig_getUserColor = function () {return &#39;#ff00ff&#39;;};</code></p>
<p>This returns the user’s preferred color that represents them.  This should be a CSS color.</p>
<p>The names might confuse you: you are providing functions that NynjaCB will call to get the user’s name, avatar, and color.  It doesn’t return the name the user has set through NynjaCB (that would be <code>NynjaCB.require(&quot;peers&quot;).Self.name</code>).</p>
<p>If any of these values are updated while in the page (like if you have a login process that doesn’t cause a page reload) then call <code>NynjaCB.refreshUserData()</code> and the respective <code>getUser*</code> callbacks will all be called again.</p>
<p>See <a href="https://github.com/mozilla/nynjacb/issues/504">#504</a> for a bug related to improving this support.</p>
<h3 id="nynjacb-reinitialize-">NynjaCB.reinitialize&#40;&#41;</h3>
<p>You can run this to try to reinitialize anything NynjaCB initializes on page load.  In particular you can use it if there are new code editors or video elements that should be sync’d, but were added dynamically to the page.  E.g.:</p>
<pre><code class="lang-javascript">$(<span class="string">"#content"</span>).append(<span class="string">'&lt;video src="foo.mov"&gt;'</span>);
NynjaCB.reinitialize();
</code></pre>
<h3 id="nynjacb-events">NynjaCB events</h3>
<p>The <code>NynjaCB</code> object is an event emitter.  It uses the style of <code>NynjaCB.on(&quot;event&quot;, handler)</code>.  The available events:</p>
<ul>
<li><code>NynjaCB.on(&quot;ready&quot;, function () {})</code>: emitted when NynjaCB is fully started up.</li>
<li><code>NynjaCB.on(&quot;close&quot;, function () {})</code>: emitted when NynjaCB is closed.  This is <em>not</em> emitted when the page simply closes or navigates elsewhere.  It is only closed when NynjaCB is specifically stopped.</li>
</ul>
<h3 id="deferring-initialization">Deferring Initialization</h3>
<p>NynjaCB starts up automatically as soon as it can, especially when continuing a session.  Sometimes this is problematic, like an application that bootstraps all of its UI after page load.  To defer this initialization, define a function <code>NynjaCBConfig_callToStart</code> like:</p>
<pre><code class="lang-js">NynjaCBConfig_callToStart = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  MyApp.onload = callback;
};
</code></pre>
<p>In this example when <code>MyApp.onload()</code> is called, NynjaCB will start to initialize itself.  Note that calling <code>NynjaCB.reinitialize()</code> might be sufficient for your application’s needs if it does a lot of setup after the page loads.</p>
<h3 id="invitation">Invitation</h3>
<p>Sometimes instead of having the user invite someone to NynjaCB you might want to handle the invitation internally in your app.  So typically when the person started NynjaCB, you’d want to find some other person they want to collaborate with and send the NynjaCB link to them.  To get at the NynjaCB link:</p>
<pre><code class="lang-js">NynjaCBConfig_on_ready = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  sendNynjaCBURLToServer(NynjaCB.shareUrl());
};
</code></pre>
<p>If you call <code>NynjaCB.shareUrl()</code> before NynjaCB is initialized it will return <code>null</code>.</p>
<h3 id="getting-at-the-innards">Getting At The Innards</h3>
<p>You can still get at NynjaCB, even if you can’t rely on the internals not to change underneath you.  (You would be well recommended to deploy your own copy of the client if you do this stuff.)</p>
<p>Most of the NynjaCB features are implemented as individual modules, so it should be possible to introduce your own module to do many of the same things.  The most important thing is the <code>session</code> module, and sending and receiving messages.</p>
<p>To get the session module (or any module) you can run this after NynjaCB starts:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> session = NynjaCB.require(<span class="string">"session"</span>);
</code></pre>
<p>This assumes that the module has already been loaded… but that assumption would be correct once NynjaCB has started.</p>
<h2 id="getting-a-static-copy-of-the-client">Getting a static copy of the client</h2>
<p>You may also want a static copy of the client that you can host yourself.  Run <code>grunt build</code> to create a static copy of the NynjaCB library in <code>build/</code> (use <code>--dest</code> to control the output location, and <code>--exclude-tests</code> to avoid including the tests in your version).</p>
<p>The hub changes quite infrequently, so if you just stability then making a static copy of the client will do it for you.  This option is highly recommended for production!</p>
<h2 id="localization-support">Localization Support</h2>
<ul>
<li>Check <a href="../../nynjacb/locale/en-US.json">translation file</a> for template example if you want to translate into your own language</li>
<li>Adding new language inside <a href="../../nynjacb/locale/">locale</a> directory should be in this format: “th-TH.json”, “th.json”, “pt-BR.json” or “pt.json” and enable support language in <a href="../../nynjacb/nynjacb.js#L320"><code>availableTranslations</code></a> inside nynjacb.js file.  Note that your file name and language names in  your configuration should use hyphens in accord with <a href="http://tools.ietf.org/html/bcp47">BCP 47</a>, not underscores.</li>
</ul>
<p>To get your language display you can enable it by:</p>
<pre><code class="lang-html"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript">
  <span class="keyword">var</span> NynjaCBConfig_lang = <span class="string">"pt-BR"</span>;
</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</code></pre>
<h2 id="browser-support">Browser Support</h2>
<p>NynjaCB is intended for relatively newer browsers.  Especially as we experiment with what we’re doing, supporting older browsers causes far more challenge than it is an advantage.</p>
<p>The bare minimum that we’ve identified for NynjaCB is <a href="http://caniuse.com/websockets">WebSocket support</a>.  That said, we generally only test on the most recent version of Firefox and Chrome, so bugs specific to older browsers are more likely (but please <a href="https://github.com/mozilla/nynjacb/issues/new">submit bugs</a> from those browsers anyway – we aren’t deliberately not supporting them). Our next set of browsers to target will be mobile browsers.</p>
<h3 id="supported-browsers">Supported Browsers</h3>
<p>We recommend the most recent release of <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> or <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a>.</p>
<p>If you want to have <a href="https://github.com/mozilla/nynjacb/wiki/About-Audio-Chat-and-WebRTC">WebRTC support</a> and are using Firefox, as of April 2013 this requires <a href="http://nightly.mozilla.org/">Firefox Nightly</a> (this support will be moving towards beta and release in the coming months).</p>
<p>We haven’t done much testing on mobile (yet!) and cannot recommend anything there.</p>
<h4 id="internet-explorer">Internet Explorer</h4>
<p>With IE 10 it is <em>possible</em> to support Internet Explorer (version 9 and before do not support WebSockets).  However we do not test at all regularly on Internet Explorer, and we know we have active issues but are not trying to fix them.  Pull requests to support Internet Explorer are welcome, but right now we don’t plan to address bug reports for Internet Explorer that don’t come with a pull request.  If Internet Explorer support is important to you we do <a href="https://docs.google.com/a/mozilla.com/forms/d/1lVE7JyRo_tjakN0mLG1Cd9X9vseBX9wci153z9JcNEs/viewform">welcome your feedback</a>. No decision is set in stone, but we don’t want to mislead you with respect to our current priorities and intentions.</p>
<p>We need your help!  If you’re itching to help out, it would be great if you take on one of these Internet Explorer bugs <a href="https://github.com/mozilla/nynjacb/issues?labels=IE&amp;milestone=&amp;page=1&amp;state=open">here</a>!</p>
<h2 id="hosting-the-hub-server">Hosting the Hub Server</h2>
<p>We have a server at <code>https://hub.nynjacb.com</code> which you are welcome to use for peer-to-peer communications with NynjaCB.  But you may wish to host your own.  The server is fairly small and simple, so it should be reasonable.  Note that we haven’t really “finished” the story around self-hosting, so the details of this are likely to change.  The server itself is quite stable.</p>
<p>The server is located in <code>hub/server.js</code>, and is a simple Node.js application.  You can run this like <code>node hub/server.js</code> - use <code>node hub/server.js --help</code> to see the available options.  You will need to <code>npm install websocket optimist</code> to get the websocket library and option library installed.</p>
<p>If you want to use NynjaCB on an https site you must host the hub on https.  We don’t have it set up in <code>server.js</code> for Node to do SSL directly, so we recommend a proxy. <a href="https://www.stunnel.org/">stunnel</a> is an example of the kind of proxy you’d want – not all proxies support websockets.</p>
<p>If you want to change the port or interface the server binds to, simply run <code>node hub/server.js -h</code> and it will show the command-line options as well as environmental variables.</p>
<p>Once you have the hub installed you need to configure NynjaCB to use the hub, like:</p>
<pre><code class="lang-javascript">NynjaCBConfig_hubBase = <span class="string">"https://myhub.com"</span>;
</code></pre>
<p>If you are curious about the exact version of code on the server it should be always be <a href="https://github.com/mozilla/nynjacb/blob/master/hub/server.js">server.js on master</a>, and you can double-check by fetching <a href="https://hub.nynjacb.com/server-source"><code>/server-source</code></a>.</p>
<h3 id="deploying-the-hub-server-to-heroku">Deploying the hub server to Heroku</h3>
<p>You need a Heroku account. If you don’t have one, their <a href="https://devcenter.heroku.com/articles/getting-started-with-nodejs">Node.js getting started guide</a> is a good place to start.</p>
<p>What’s about to happen: we clone the repo and create a new Heroku app within it. We need to set the HOST environment variable to get the app to bind to 0.0.0.0 instead of 127.0.0.1. It’ll pick up the PORT variable automatically. We also need to enable WebSockets for the app. Then, push the code and we should be good to go!</p>
<pre><code><span class="title">git</span> clone git@github.com:mozilla/nynjacb.git
<span class="title">cd</span> nynjacb
<span class="title">heroku</span> create
<span class="title">heroku</span> config:add <span class="type">HOST</span>=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>
<span class="title">git</span> push heroku master
</code></pre><p>Make note of the app name after running <code>heroku create</code> You can check that everything is running by going to <a href="http://your-app-name-here.herokuapp.com/status">http://your-app-name-here.herokuapp.com/status</a></p>
<h2 id="addons">Addons</h2>
<p>There is an addon for Firefox in <a href="https://github.com/mozilla/nynjacb/tree/develop/addon">addon/</a>.</p>
<p>This isn’t intended to be the “normal” way anyone uses NynjaCB, but it is a development tool to try NynjaCB out on a site that hasn’t integrated <code>nynjacb-min.js</code> itself.  When you activate the addon (via a link in the <a href="https://support.mozilla.org/en-US/kb/add-on-bar-quick-access-to-add-ons">Add-On Toolbar</a>) it simply adds <code>nynjacb-min.js</code> to every page in that tab (until you close the tab or turn it off).  Also if you open a link with <code>#&amp;nynjacb=...</code> (the code used in the share link) it will automatically turn NynjaCB on for the tab.</p>
<h3 id="installing">Installing</h3>
<p>A simple way to install is simply to <a href="https://nynjacb.com/nynjacb.xpi">click this link</a> in Firefox, and install the addon.  You can turn the addon on or off via the addon manager.  No restart is required.</p>
<h3 id="building">Building</h3>
<p>You can build the addon using the <a href="https://addons.mozilla.org/en-US/developers/builder">Addon-SDK</a>. Once you’ve installed the SDK, go into the <code>addon/</code> directory and run <code>cfx xpi</code> to create an XPI (packaged addon file) or <code>cfx run</code> to start up Firefox with the addon installed (for development).</p>
<h2 id="getting-help">Getting Help</h2>
<h3 id="irc-live-chat">IRC / Live Chat</h3>
<p>We are available on the <code>#nynjacb</code> channel on <code>irc.mozilla.org</code>. Logs are on <a href="http://irclog.gr/#browse/irc.mozilla.org/nynjacb">irclog.gr</a></p>
<p>If you don’t use IRC, you can quickly join the chat from the web <a href="https://kiwiirc.com/client/irc.mozilla.org/nynjacb">using kiwiirc</a>.</p>
<h3 id="issues">Issues</h3>
<p>Please submit any issues you have via <a href="https://github.com/mozilla/nynjacb/issues/new">the Github issue tracker</a>.</p>
<p>Don’t be shy about opening an issue.  If you have a question or feature request that might already be possible, we can exchange comments via the issue tracker to figure it out.  We don’t have a mailing list, so issues are a good way to keep a persistent record of these exchanges.</p>
<h3 id="email">Email</h3>
<p>Feel free to email us at <a href="mailto:nynjacb@mozilla.com">nynjacb@mozilla.com</a> with any questions, suggestions, or concerns.</p>

    </div>
  </section>




        <hr>

        <footer>

          <section class="row" id="footer">
            <div class="col-xs-12 col-sm-3 text-left">
              <p><a href="https://mozillalabs.com/en-US/" target="_blank"><img src="../images/footer-mozilla-labs.png"></a></p>
            </div>
            <div class="col-xs-12 col-sm-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href=".././" class="">Overview</a></li>
                <li><a href=".././docs/" target="_blank">Docs</a></li>
                <li class=""><a href="https://github.com/mozilla/nynjacb" target="_blank">GitHub</a></li>
                <li class=""><a href="mailto:nynjacb@mozilla.com" target="_blank">Contact</a></li>
              </ul>
            </div>
            <div class="col-xs-12 col-sm-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://mozillalabs.com/en-US/nynjacb/" target="_blank">About</a></li>
                <li><a href=".././docs/contributing.html">Contributing</a></li>
                <li><a href="../source/">Source Code</a></li>
                <li><a href="../faq.html">FAQ</a></li>
                <li class=""><a href="https://twitter.com/nynjacb" target="_blank">Twitter</a></li>
              </ul>
            </div>
            <div class="col-xs-12 col-sm-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://www.mozilla.org/privacy/websites/" target="_blank">Privacy Policy</a></li>
                <li class=""><a href="https://www.mozilla.org/about/legal/" target="_blank">Legal Notices</a></li>
                <li class=""><a href="https://www.mozilla.org/legal/fraud-report/" target="_blank">Report Trademark Abuses</a></li>
                <li class="ph-credit">Thanks to Yuan Wang for the cover photo!</li>
              </ul>
            </div>
          </section>
        </footer>
      </section>

    </div> <!-- /container -->

  </body>
</html>
